<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta
      http-equiv="Content-Security-Policy"
      content="default-src 'self'; script-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com; style-src 'self' 'unsafe-inline'; connect-src *;"
    />
    <title>Kinect Azure WebRTC 视频通话</title>
    <style>
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      body {
        font-family: "Microsoft YaHei", "Arial", sans-serif;
        background-color: #f5f5f5;
        color: #333;
        line-height: 1.6;
      }

      header {
        background-color: #2980b9;
        color: #fff;
        text-align: center;
        padding: 0.5rem;
      }

      .container {
        width: 96%;
        max-width: 1000px;
        margin: 0 auto;
        padding: 0.5rem;
      }

      .connection-controls {
        background-color: #fff;
        padding: 0.5rem;
        border-radius: 5px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        margin-bottom: 0.5rem;
        display: flex;
        align-items: center;
        flex-wrap: wrap;
        gap: 8px;
      }

      input,
      button,
      select {
        padding: 0.4rem;
        border: 1px solid #ddd;
        border-radius: 3px;
      }

      input,
      select {
        flex: 1;
        min-width: 100px;
      }

      button {
        background-color: #3498db;
        color: white;
        border: none;
        cursor: pointer;
        transition: background-color 0.3s;
        white-space: nowrap;
      }

      button:hover {
        background-color: #2980b9;
      }

      button:disabled {
        background-color: #95a5a6;
        cursor: not-allowed;
      }

      .status-container {
        background-color: #fff;
        padding: 0.5rem;
        border-radius: 5px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        margin-bottom: 0.5rem;
        display: flex;
        flex-direction: column;
        gap: 0.3rem;
      }

      .status-item {
        display: flex;
        justify-content: space-between;
        padding: 0.3rem;
        border-bottom: 1px solid #eee;
      }

      .status-item:last-child {
        border-bottom: none;
      }

      #connectionStatus,
      #audioStatus,
      #serverStatus {
        padding: 0.3rem;
        border-radius: 4px;
        margin-left: auto;
      }

      #connectionStatus.error,
      #audioStatus.error,
      #serverStatus.error {
        background-color: #e74c3c;
        color: white;
      }

      #connectionStatus.success,
      #audioStatus.success,
      #serverStatus.success {
        background-color: #2ecc71;
        color: white;
      }

      #connectionStatus.warning,
      #audioStatus.warning,
      #serverStatus.warning {
        background-color: #f39c12;
        color: white;
      }

      .video-container {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 0.5rem;
        margin-bottom: 0.5rem;
      }

      .video-box {
        background-color: #fff;
        border-radius: 5px;
        overflow: hidden;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        position: relative;
      }

      .video-box h3 {
        background-color: #34495e;
        color: white;
        padding: 0.3rem;
        margin: 0;
        font-size: 0.9rem;
      }

      canvas,
      video {
        width: 100%;
        height: auto;
        display: block;
        background-color: #000;
      }

      .controls-container {
        margin-bottom: 0.5rem;
      }

      .audio-controls,
      .kinect-controls {
        background-color: #fff;
        padding: 0.5rem;
        border-radius: 5px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        margin-bottom: 0.5rem;
        display: flex;
        align-items: center;
        flex-wrap: wrap;
        gap: 8px;
      }

      .controls-row {
        display: flex;
        align-items: center;
        flex-wrap: wrap;
        gap: 8px;
      }

      .volume-control {
        display: flex;
        align-items: center;
        gap: 0.3rem;
        margin-left: 0.5rem;
      }

      .debug-panel {
        background-color: #fff;
        padding: 0.5rem;
        border-radius: 5px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        margin-top: 0.5rem;
        display: none;
      }

      .debug-panel.show {
        display: block;
      }

      #logs {
        height: 150px;
        overflow-y: auto;
        background-color: #f8f9fa;
        padding: 0.5rem;
        font-family: monospace;
        font-size: 12px;
        border: 1px solid #ddd;
        margin-top: 0.3rem;
      }

      #pointCloudToggle {
        background-color: #9b59b6;
      }

      #pointCloudToggle:hover {
        background-color: #8e44ad;
      }

      .device-info {
        font-size: 0.8rem;
        color: #7f8c8d;
        margin-bottom: 0.3rem;
      }

      @media (max-width: 768px) {
        .video-container {
          grid-template-columns: 1fr;
        }

        .connection-controls,
        .audio-controls,
        .kinect-controls {
          flex-direction: column;
          align-items: stretch;
        }
      }
    </style>
  </head>
  <body>
    <header>
      <h1>Kinect Azure WebRTC 视频通话</h1>
      <div class="device-info">
        支持 Kinect Azure 设备，无 Kinect 设备时自动使用普通摄像头
      </div>
    </header>

    <div class="container">
      <div class="status-container">
        <div class="status-item">
          <span>服务器状态:</span>
          <span id="serverStatus">未连接</span>
        </div>
        <div class="status-item">
          <span>连接状态:</span>
          <span id="connectionStatus">未连接</span>
        </div>
        <div class="status-item">
          <span>音频状态:</span>
          <span id="audioStatus">音频未连接</span>
        </div>
      </div>

      <div class="connection-controls">
        <input type="text" id="roomIdInput" value="1" placeholder="房间ID" />
        <input type="text" id="userIdInput" placeholder="用户名" />
        <input
          type="text"
          id="serverUrlInput"
          value="http://10.29.196.83:3001"
        />
        <button id="connectButton">加入房间</button>
        <button id="localTestButton">本地测试</button>
        <button id="showDebugButton">显示调试信息</button>
      </div>

      <div class="controls-container">
        <div class="audio-controls">
          <button id="muteButton" disabled>静音</button>
          <div class="volume-control">
            <label for="volumeSlider">音量:</label>
            <input
              type="range"
              id="volumeSlider"
              min="0"
              max="1"
              step="0.1"
              value="1"
              disabled
            />
          </div>
          <button id="cameraToggle" disabled>关闭摄像头</button>
        </div>

        <!-- Kinect 控制区域，在检测到 Kinect 时通过 JavaScript 显示 -->
        <div class="kinect-controls" id="kinectControls" style="display: none">
          <span>Kinect 控制:</span>
          <select id="viewModeSelect">
            <option value="color">彩色视频</option>
            <option value="pointCloud">彩色点云</option>
          </select>
        </div>
      </div>

      <div class="video-container">
        <div class="video-box">
          <h3>本地视频</h3>
          <canvas id="localVideo"></canvas>
        </div>

        <div class="video-box">
          <h3>远程视频</h3>
          <video id="remoteVideo" autoplay playsinline></video>
        </div>
      </div>

      <div class="debug-panel" id="debugPanel">
        <h3>调试信息</h3>
        <div id="logs"></div>
      </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/simple-peer/9.11.1/simplepeer.min.js"></script>
    <script src="../kinect-azure/examples/electron/renderer/assets/vendors/three.js/build/three.min.js"></script>
    <script src="../kinect-azure/examples/electron/renderer/assets/vendors/three.js/examples/js/controls/OrbitControls.js"></script>
    <script src="webrtc.js"></script>
    <script src="app.js"></script>
  </body>
</html>
