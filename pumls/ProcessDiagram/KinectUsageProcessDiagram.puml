@startuml
title Kinect用户参与会议流程图

|用户|
start
:选择使用Kinect模式;

|客户端应用|
:检测Kinect设备;
:启用Kinect控制面板;

|摄像头管理|
:加载Kinect-Azure库;
:初始化Kinect设备;
if (Kinect初始化成功?) then (成功)
  :配置Kinect视图模式;
  :设置Kinect参数;
else (失败)
  :返回错误信息;
  :回退到标准摄像头;
endif
:启动Kinect数据流;
:创建帧处理循环;

|客户端应用|
:显示本地Kinect视频预览;
:启用视图模式选择器;

|用户|
:选择视图模式\n(彩色视频/点云);

|摄像头管理|
if (选择的模式) then (彩色视频)
  :处理RGB视频流;
  :应用视频增强处理;
else (点云模式)
  :初始化ThreeJS渲染器;
  :设置点云渲染参数;
  :转换深度数据为点云数据;
endif
:准备帧数据;

|WebRTC连接|
:获取Kinect处理后的媒体流;
:将媒体流添加到P2P连接;
:创建专用点云数据通道;
:通知远程用户视图模式变更;

|信令服务器|
:转发模式变更消息;

|WebRTC连接|
if (当前为点云模式) then (是)
  :压缩点云数据;
  :通过数据通道发送点云数据;
else (视频模式)
  :通过视频轨道发送视频流;
endif

|客户端应用|
:同步更新UI显示当前模式;
:显示网络状态信息;

|用户|
:调整Kinect视角或参数;
:实时查看效果;
stop
@enduml